#!/bin/bash
# /var/www/megahub/scripts/deploy-env.sh
# Script unifi√© de d√©ploiement multi-environnements selon standards leaders
# ‚úÖ VERSION MISE √Ä JOUR - Collectstatic robuste int√©gr√©

set -euo pipefail

# ==========================================
# CONFIGURATION ENVIRONNEMENTS
# ==========================================
PROJECT_DIR="/var/www/megahub"
SOURCE_DIR="$PROJECT_DIR/source"                     # ‚Üê Nouvelle architecture
FRONTEND_DIR="$SOURCE_DIR/frontend"                  # ‚Üê Nouveau chemin
BACKEND_DIR="$SOURCE_DIR/backend"                    # ‚Üê Nouveau chemin
BACKUP_DIR="$PROJECT_DIR/backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

ENVIRONMENT=${1:-development}

# Configuration par environnement
case $ENVIRONMENT in
    "development")
        COMPOSE_FILE="docker-compose.yml"
        PROJECT_NAME="megahub-dev"
        FRONTEND_CONTAINER="megahub-frontend-dev"
        BACKEND_CONTAINER="megahub-backend-dev"
        DJANGO_SETTINGS="django_app.settings.development"
        FRONTEND_URL="http://localhost:3000"
        BACKEND_URL="http://localhost:8000"
        GIT_BRANCH="main"
        ;;
    "staging")
        COMPOSE_FILE="docker-compose.staging.yml"
        PROJECT_NAME="megahub-staging"
        FRONTEND_CONTAINER="megahub-frontend-staging"
        BACKEND_CONTAINER="megahub-backend-staging"
        DJANGO_SETTINGS="django_app.settings.staging"
        FRONTEND_URL="https://staging.megahub.humari.fr"
        BACKEND_URL="https://staging-api.megahub.humari.fr"
        GIT_BRANCH="develop"
        ;;
    "production")
        COMPOSE_FILE="docker-compose.production.yml"
        PROJECT_NAME="megahub-production"
        FRONTEND_CONTAINER="megahub-frontend-prod"
        BACKEND_CONTAINER="megahub-backend-prod"
        DJANGO_SETTINGS="django_app.settings.production"
        FRONTEND_URL="https://megahub.humari.fr"
        BACKEND_URL="https://backoffice.humari.fr"
        GIT_BRANCH="main"
        ;;
    *)
        echo "‚ùå Environnement non valide: $ENVIRONMENT"
        echo "Usage: $0 {development|staging|production}"
        exit 1
        ;;
esac

mkdir -p "$BACKUP_DIR"

# ==========================================
# FONCTIONS UTILITAIRES
# ==========================================
log() { echo "[$(date +'%H:%M:%S')] $1"; }
success() { echo "‚úÖ $1"; }
error() { echo "‚ùå $1"; exit 1; }
react19_log() { echo "üöÄ [React 19] $1"; }
django_log() { echo "üêç [Django] $1"; }

log "üöÄ D√©ploiement MegaHub $ENVIRONMENT - Architecture Leaders"

# ==========================================
# PROTECTION PRODUCTION
# ==========================================
if [ "$ENVIRONMENT" = "production" ]; then
    echo "‚ö†Ô∏è  ATTENTION: D√©ploiement en PRODUCTION"
    read -p "Tapez 'PRODUCTION' pour confirmer: " confirmation
    if [ "$confirmation" != "PRODUCTION" ]; then
        echo "D√©ploiement annul√©"
        exit 1
    fi
fi

# ==========================================
# BACKUP AVANT D√âPLOIEMENT
# ==========================================
backup_current_state() {
    log "üì¶ Backup de l'√©tat actuel $ENVIRONMENT"
    
    # Backup frontend si existe
    if [ -d "$FRONTEND_DIR/dist" ]; then
        tar -czf "$BACKUP_DIR/frontend_${ENVIRONMENT}_backup_$TIMESTAMP.tar.gz" -C "$FRONTEND_DIR" dist
        success "Frontend backup cr√©√©"
    fi
    
    # Backup base de donn√©es si pas development
    if [ "$ENVIRONMENT" != "development" ]; then
        log "üì¶ Backup base de donn√©es $ENVIRONMENT"
        
        # V√©rifier que les containers existent avant backup
        if docker ps -q -f name=$BACKEND_CONTAINER >/dev/null 2>&1; then
            # Variables DB pour l'environnement
            case $ENVIRONMENT in
                "staging")
                    POSTGRES_USER="SuperAdminduTurfu"
                    POSTGRES_DB="mhdb24_staging"
                    ;;
                "production")
                    POSTGRES_USER="SuperAdminduTurfu"  
                    POSTGRES_DB="mhdb24"
                    ;;
            esac
            
            # Backup via container backend (acc√®s DB interne)
            docker exec $BACKEND_CONTAINER pg_dump \
                -h postgres \
                -U "$POSTGRES_USER" \
                -d "$POSTGRES_DB" \
                > "$BACKUP_DIR/db_${ENVIRONMENT}_backup_$TIMESTAMP.sql" 2>/dev/null || log "‚ö†Ô∏è Backup DB √©chou√©"
        else
            log "‚ö†Ô∏è Container $BACKEND_CONTAINER non trouv√© - Skip backup DB"
        fi
    fi
    
    # Tag Git pour rollback possible
    cd "$SOURCE_DIR"
    git tag "backup-${ENVIRONMENT}-${TIMESTAMP}"
    git push origin "backup-${ENVIRONMENT}-${TIMESTAMP}" || log "‚ö†Ô∏è Push tag backup √©chou√©"
}

# ==========================================
# MISE √Ä JOUR CODE SOURCE
# ==========================================
update_source_code() {
    log "üì• Mise √† jour code source depuis $GIT_BRANCH"
    cd "$SOURCE_DIR"
    
    # ‚úÖ PAS DE git reset --hard ! (probl√®me r√©solu)
    git fetch origin $GIT_BRANCH
    git checkout $GIT_BRANCH
    git pull origin $GIT_BRANCH
    
    react19_log "Code React 19 mis √† jour depuis $GIT_BRANCH"
    django_log "Code Django mis √† jour avec settings $DJANGO_SETTINGS"
}

# ==========================================
# BUILD FRONTEND REACT 19
# ==========================================
build_frontend() {
    log "üèóÔ∏è Build Frontend React 19 pour $ENVIRONMENT"
    cd "$FRONTEND_DIR"
    
    # Install dependencies
    log "üì¶ Installation d√©pendances React 19"
    npm ci
    
    # Audit security
    log "üîí Audit s√©curit√©"
    npm audit fix --force || log "‚ö†Ô∏è Vuln√©rabilit√©s d√©tect√©es"
    
    # Type check strict
    log "üìù TypeScript check strict"
    npm run type-check:strict
    
    # Lint
    log "üîç Linting"
    npm run lint:ci || log "‚ö†Ô∏è Warnings lint d√©tect√©s"
    
    # Routes TanStack
    log "üõ§Ô∏è G√©n√©ration routes TanStack"
    npm run routes:generate
    
    # Build avec variables d'environnement
    log "üèóÔ∏è Build React 19 + Lightning CSS"
    export VITE_ENV=$ENVIRONMENT
    npm run build
    
    # V√©rifications build
    [ ! -d "dist" ] && error "Build √©chou√© - dist manquant"
    [ ! -f "dist/index.html" ] && error "Build √©chou√© - index.html manquant"
    
    JS_FILES=$(find dist/assets -name "*.js" | wc -l 2>/dev/null || echo "0")
    [ "$JS_FILES" -lt 1 ] && error "Build incomplet - JS files manquants"
    
    react19_log "Build r√©ussi - $JS_FILES fichiers JS g√©n√©r√©s"
    log "üìä Taille build: $(du -sh dist | cut -f1)"
}

# ==========================================
# MIGRATIONS DJANGO
# ==========================================
run_migrations() {
    django_log "üóÉÔ∏è Migrations Django $ENVIRONMENT"
    
    # V√©rifier connexion DB
    docker exec $BACKEND_CONTAINER python manage.py check --database=default || error "Connexion DB √©chou√©e"
    
    # Migrations
    docker exec $BACKEND_CONTAINER python manage.py migrate --database=default
    
    django_log "Migrations $ENVIRONMENT termin√©es"
}

# ==========================================
# ‚úÖ COLLECTSTATIC ROBUSTE - PERMISSIONS FIX
# ==========================================
run_collectstatic() {
    if [ "$ENVIRONMENT" != "development" ]; then
        django_log "üì¶ Collectstatic $ENVIRONMENT"
        
        # ‚úÖ Forcer permissions correctes sur le volume staticfiles
        log "üîí Configuration permissions staticfiles"
        docker exec --user root $BACKEND_CONTAINER chown -R debian:megahub_devs /app/staticfiles || log "‚ö†Ô∏è Chown staticfiles √©chou√©"
        docker exec --user root $BACKEND_CONTAINER chmod -R 755 /app/staticfiles || log "‚ö†Ô∏è Chmod staticfiles √©chou√©"
        
        # Cr√©er le r√©pertoire staticfiles si n√©cessaire avec bonnes permissions
        docker exec $BACKEND_CONTAINER mkdir -p /app/staticfiles || log "‚ö†Ô∏è Mkdir staticfiles √©chou√©"
        
        # V√©rifier que STATIC_ROOT est configur√©
        if docker exec $BACKEND_CONTAINER python -c "from django.conf import settings; print(settings.STATIC_ROOT)" >/dev/null 2>&1; then
            
            # Collectstatic avec gestion d'erreurs robuste
            log "üì¶ Lancement collectstatic"
            if docker exec $BACKEND_CONTAINER python manage.py collectstatic --noinput --clear; then
                success "Collectstatic r√©ussi"
                
                # V√©rification post-collectstatic
                STATIC_COUNT=$(docker exec $BACKEND_CONTAINER find /app/staticfiles -type f 2>/dev/null | wc -l || echo "0")
                django_log "üìä $STATIC_COUNT fichiers static collect√©s"
                
                # V√©rification finale permissions
                docker exec --user root $BACKEND_CONTAINER chmod -R 755 /app/staticfiles || log "‚ö†Ô∏è Chmod final staticfiles √©chou√©"
                
                # V√©rification espace disque
                STATIC_SIZE=$(docker exec $BACKEND_CONTAINER du -sh /app/staticfiles 2>/dev/null | cut -f1 || echo "Unknown")
                django_log "üíæ Taille staticfiles: $STATIC_SIZE"
                
            else
                log "‚ö†Ô∏è Collectstatic √©chou√© - Continuons sans static files"
                # En staging/prod, ne pas faire √©chouer le d√©ploiement pour collectstatic
            fi
        else
            log "‚ö†Ô∏è STATIC_ROOT non configur√© - Ignorons collectstatic"
        fi
    else
        django_log "üîß Development - Pas de collectstatic n√©cessaire (runserver sert directement)"
    fi
}

# ==========================================
# D√âPLOIEMENT DOCKER
# ==========================================
deploy_containers() {
    log "üê≥ D√©ploiement Docker $ENVIRONMENT"
    cd "$PROJECT_DIR"
    
    # Arr√™t propre avec project name
    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE stop 2>/dev/null || true
    
    # Build et d√©marrage avec project name
    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE up -d --build
    
    success "Containers $ENVIRONMENT d√©marr√©s"
}

# ==========================================
# HEALTH CHECKS ROBUSTES
# ==========================================
health_checks() {
    log "üè• Health checks $ENVIRONMENT"
    
    # Attendre d√©marrage
    log "‚è≥ Attente d√©marrage (20s)..."
    sleep 20
    
    # Check containers avec project name
    if ! docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE ps | grep -q -E "(Up|healthy)"; then
        error "Containers ne d√©marrent pas"
    fi
    success "Containers actifs"
    
    # Health check interne frontend
    log "ü©∫ Health check frontend interne..."
    for i in {1..6}; do
        if docker exec $FRONTEND_CONTAINER curl -f http://localhost/health >/dev/null 2>&1; then
            success "Frontend health OK"
            break
        fi
        log "‚è≥ Tentative $i/6..."
        sleep 10
    done
    
    # Health check interne backend
    log "ü©∫ Health check backend interne..."
    for i in {1..6}; do
        if docker exec $BACKEND_CONTAINER python /app/health_check.py >/dev/null 2>&1; then
            success "Backend health OK"
            break
        fi
        log "‚è≥ Tentative $i/6..."
        sleep 10
    done
    
    # Health check externe (si pas development)
    if [ "$ENVIRONMENT" != "development" ]; then
        log "üåê Health check externe..."
        sleep 30  # Attendre SSL/nginx-proxy
        
        for i in {1..10}; do
            if curl -f -s --max-time 10 "$FRONTEND_URL/health" >/dev/null 2>&1; then
                success "Health check externe r√©ussi"
                break
            fi
            log "‚è≥ Tentative externe $i/10..."
            sleep 15
        done
    fi
}

# ==========================================
# TEST PERFORMANCE
# ==========================================
performance_test() {
    if [ "$ENVIRONMENT" != "development" ]; then
        log "üìä Test performance $ENVIRONMENT"
        
        RESPONSE_TIME=$(curl -w "%{time_total}" -o /dev/null -s --max-time 15 "$FRONTEND_URL/" 2>/dev/null || echo "ERROR")
        
        if [ "$RESPONSE_TIME" != "ERROR" ]; then
            react19_log "Temps de r√©ponse: ${RESPONSE_TIME}s"
            
            if (( $(echo "$RESPONSE_TIME < 1.0" | bc -l) )); then
                success "Performance excellente (< 1s) ‚úÖ"
            elif (( $(echo "$RESPONSE_TIME < 2.0" | bc -l) )); then
                log "‚ö†Ô∏è Performance acceptable (< 2s)"
            else
                log "‚ö†Ô∏è Performance lente (> 2s)"
            fi
        fi
    fi
}

# ==========================================
# ‚úÖ EX√âCUTION PRINCIPALE MISE √Ä JOUR
# ==========================================
main() {
    backup_current_state
    update_source_code
    build_frontend
    deploy_containers
    run_migrations
    run_collectstatic  # ‚úÖ AJOUT - Collectstatic apr√®s migrations
    health_checks
    performance_test
    
    # Cleanup
    log "üßπ Nettoyage Docker"
    docker image prune -f >/dev/null 2>&1
    
    # Status final
    log "üìä Status final $ENVIRONMENT:"
    docker-compose -p $PROJECT_NAME -f $COMPOSE_FILE ps
    
    success "üéâ D√©ploiement $ENVIRONMENT r√©ussi!"
    log "üåê Frontend: $FRONTEND_URL"
    log "üêç Backend: $BACKEND_URL"
    log "üìà Monitoring: docker-compose -f $COMPOSE_FILE logs -f"
    log "üîç Debug: ./scripts/debug-env.sh $ENVIRONMENT"
}

main